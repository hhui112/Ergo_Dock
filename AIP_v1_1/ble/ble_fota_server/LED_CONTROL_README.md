# LED控制模块重构说明

## 📋 概述

本次重构完全重新设计了LED控制模块，解决了原有代码的架构问题和bug。

### 主要改进：

1. **独立的LED管理** - 每个LED有独立的状态和定时器，互不干扰
2. **优先级机制** - 支持高优先级任务（如充电异常、配对）覆盖低优先级任务
3. **自动超时管理** - 无需手动管理倒计时，LED模块自动处理
4. **回调机制** - 支持LED任务完成后的回调函数（用于顺序执行）
5. **清晰的业务API** - 业务逻辑与硬件控制完全解耦

## 🔧 文件结构

### 新增文件：
- `app_led_ctrl.h` - LED控制模块头文件
- `app_led_ctrl.c` - LED控制模块实现

### 修改文件：
- `main.c` - 添加LED模块初始化
- `timer_event.c` - 替换LED定时处理函数
- `x_control.c` - 更新按键和充电检测逻辑
- `offline_voice.c` - 更新语音控制逻辑

### 保留文件（待废弃）：
- `app_led.c` / `app_led.h` - 旧的LED控制（暂时保留，可逐步删除）

## 🎨 LED物理结构

| LED编号 | 蓝色引脚 | 绿色引脚 | 红色引脚 | 用途 |
|---------|---------|---------|---------|------|
| LED 0 | PA02 | ❌ | PB13（共享） | 打鼾档位Low |
| LED 1 | PA00 | PA01 | PB13（共享） | 打鼾档位Med / 无线充指示 |
| LED 2 | PB15 | ❌ | PB13（共享） | 打鼾档位High |
| LED 3 | PB09 | PB10 | ❌ | 语音唤醒 / 蓝牙配对 |

**注意**：红色引脚PB13是LED 0/1/2的公共引脚，点亮时3个LED同时亮红灯。

## 📖 API使用说明

### 1. 初始化（在main函数中调用）

```c
#include "app_led_ctrl.h"

int main() {
    // ... 其他初始化 ...
    led_ctrl_init();  // 初始化LED控制模块
    // ... 继续其他初始化 ...
}
```

### 2. 定时器处理（在10ms定时器中调用）

```c
void ls_10ms_timer_cb(void *param) {
    // ... 其他处理 ...
    led_ctrl_10ms_handler();  // LED控制模块定时处理
    // ... 其他处理 ...
}
```

### 3. 业务API使用

#### 3.1 打鼾档位指示

```c
// 设置打鼾档位（0=关闭, 1=Low, 2=Med, 3=High）
// 蓝色LED亮10秒后自动熄灭
led_snore_level_set(2);  // Med档

// 打鼾功能关闭指示（LED 0/1/2 闪烁2次）
led_snore_disabled_flash();
```

#### 3.2 离线语音指示

```c
// 语音唤醒：LED 3 蓝灯亮8秒
led_voice_wakeup();

// 语音命令确认：LED 3 绿灯亮3秒 → 蓝灯亮8秒（自动顺序执行）
led_voice_command_confirm();

// 语音关闭：LED 3 闪烁2次
led_voice_close_flash();
```

#### 3.3 无线充电指示

```c
// 充电正常：LED 1 绿灯亮15秒
led_charge_normal();

// 充电异常：LED 0/1/2 红灯亮30秒
led_charge_error();
```

#### 3.4 蓝牙配对指示

```c
// 开始配对（闪烁30秒）
led_bt_pairing(false);

// 配对成功（常亮，剩余时间继续倒计时）
led_bt_pairing(true);

// 停止配对
led_bt_pairing_stop();
```

### 4. 核心API（高级用法）

如果业务API不满足需求，可以使用核心API：

```c
// 设置LED常亮（带超时）
led_ctrl_set_on(LED_ID_1, LED_COLOR_BLUE, 10, LED_PRIORITY_NORMAL, NULL);
// 参数：LED编号, 颜色, 超时秒数, 优先级, 回调函数

// 设置LED闪烁
led_ctrl_set_flash(LED_ID_3, LED_COLOR_BLUE, 500, 2, 30, LED_PRIORITY_HIGH, NULL);
// 参数：LED编号, 颜色, 间隔ms, 次数, 总超时秒数, 优先级, 回调函数

// 关闭LED
led_ctrl_set_off(LED_ID_1);

// 检查LED是否激活
if (led_ctrl_is_active(LED_ID_3)) {
    // LED 3 正在使用中
}
```

## 🐛 Bug修复说明

### 原Bug：Med档LED在语音唤醒后常亮

**问题根源**：
1. 旧代码中LED 0/1/2和LED 3共享定时器管理逻辑
2. 语音唤醒时可能干扰其他LED的定时器
3. 缺乏独立的状态管理

**修复方案**：
1. 每个LED独立管理，拥有独立的定时器
2. LED 3的操作不会影响LED 0/1/2的状态
3. 优先级机制确保高优先级任务不被低优先级任务覆盖

## ⚙️ 优先级机制

优先级定义：
- `LED_PRIORITY_NORMAL (0)` - 普通（档位指示、语音唤醒）
- `LED_PRIORITY_HIGH (5)` - 高（蓝牙配对）
- `LED_PRIORITY_CRITICAL (10)` - 关键（充电异常、功能关闭闪烁）

**规则**：
- 高优先级任务可以覆盖低优先级任务
- 低优先级任务无法覆盖高优先级任务
- 同优先级任务后来者覆盖先来者

**示例**：
```c
// 场景：配对期间（高优先级）收到语音唤醒（普通优先级）
led_bt_pairing(false);  // LED 3 闪烁（高优先级）
led_voice_wakeup();     // 被拒绝，LED 3 继续闪烁（配对优先）
```

## 🧪 测试建议

### 1. 打鼾档位测试
- [ ] 短按按键，LED 0/1/2 循环亮起（蓝灯10秒）
- [ ] 长按5秒，LED 0/1/2 闪烁2次（功能关闭）
- [ ] 档位切换时，前一个LED正确熄灭

### 2. 语音控制测试
- [ ] 语音唤醒：LED 3 蓝灯亮8秒后熄灭
- [ ] 语音命令：LED 3 绿灯3秒 → 蓝灯8秒
- [ ] 语音关闭：LED 3 闪烁2次

### 3. 冲突测试（重要！）
- [ ] Med档（LED 1 蓝灯10秒）+ 语音唤醒（LED 3 蓝灯8秒）→ 两个LED独立工作
- [ ] 配对期间（LED 3 闪烁）+ 语音唤醒 → LED 3 继续闪烁（配对优先）
- [ ] 充电异常（红灯30秒）+ 档位切换 → 红灯优先，档位蓝灯被拒绝

### 4. 充电测试
- [ ] 充电正常：LED 1 绿灯15秒后熄灭
- [ ] 充电异常：LED 0/1/2 红灯30秒后熄灭
- [ ] 充电状态切换时LED正确响应

### 5. 蓝牙配对测试
- [ ] 长按3秒：LED 3 闪烁30秒
- [ ] 配对成功：LED 3 切换为常亮，剩余时间继续倒计时
- [ ] 断开连接：LED 3 恢复闪烁
- [ ] 再次长按3秒：LED 3 熄灭，停止配对

## 📝 注意事项

1. **旧代码兼容性**：
   - 旧的`app_led.c`中的函数已被注释或替换
   - 如需完全移除旧代码，请确保所有调用都已更新

2. **LOG输出**：
   - 新模块使用`LOG_I`输出重要状态信息
   - 可用于调试LED行为

3. **回调函数**：
   - 回调在LED任务完成后执行
   - 回调中可以启动新的LED任务（实现顺序逻辑）
   - 示例：`led_voice_command_confirm()` 使用回调实现绿灯→蓝灯的顺序

4. **配对期间的特殊处理**：
   - 配对使用高优先级，语音唤醒会被拒绝
   - 配对结束后，语音唤醒恢复正常

## 🔄 迁移指南

如果需要添加新的LED业务逻辑：

1. **简单场景**：直接使用业务API
2. **复杂场景**：使用核心API
3. **顺序逻辑**：使用回调函数

示例：添加新的LED指示

```c
// 在app_led_ctrl.c中添加业务函数
void led_new_feature(void)
{
    // LED 2 红灯闪烁5次，间隔300ms，总超时10秒
    led_ctrl_set_flash(LED_ID_2, LED_COLOR_RED, 300, 5, 10, 
                       LED_PRIORITY_NORMAL, NULL);
    LOG_I("新功能LED指示");
}

// 在app_led_ctrl.h中声明
void led_new_feature(void);

// 在业务代码中调用
#include "app_led_ctrl.h"
led_new_feature();
```

## ✅ 完成状态

- [x] 创建新的LED控制模块
- [x] 实现核心API和业务API
- [x] 更新所有调用方代码
- [x] 修复Med档LED常亮bug
- [x] 添加优先级机制
- [x] 添加回调机制
- [ ] 实际硬件测试验证

## 📞 问题反馈

如果在使用过程中遇到问题，请检查：
1. LED模块是否正确初始化（`led_ctrl_init()`）
2. 10ms定时器是否正确调用（`led_ctrl_10ms_handler()`）
3. LOG输出中的LED状态信息
4. 优先级设置是否合理

---

**重构完成时间**：2025-12-26
**重构目的**：解决LED控制架构问题和Med档常亮bug
**测试状态**：代码编译通过，待硬件验证

